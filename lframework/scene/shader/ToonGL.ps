precision mediump float;
//precision highp float;
precision mediump int;

#ifdef PNORMAL
varying vec3 v_normal;
#endif

#ifdef PCOLOR
varying  vec4 v_color0;
#endif

#ifdef PTEX0
varying vec2 v_tex0;
#endif

#ifdef PTEX1
varying vec2 v_tex1;
#endif

#ifdef PPOS
varying vec3 v_pos0;
#endif

const float c_fzero = 0.0;
const float c_fone = 1.0;
const float PI = 3.14159265358979323846;
const float PI2 = 6.28318530717958647692;
const float INV_PI = 0.31830988618379067153;
const float INV_PI_2 = 0.63661977236758134306;

const float ALPHA_REF = 0.5;
const float c_ffive = 5.0;

////////////////////////////////////
#ifdef LIGHTVS
uniform vec3 ambient;
uniform vec4 dlColor;

uniform vec4 diffuse;
uniform vec3 emissive;

varying vec4 v_specular0;

#ifdef TEXSHADE
varying vec2 v_tex3;
#endif

#else //LIGHTVS

uniform vec3 dlDir;
uniform vec4 dlColor;
uniform vec3 camPos;

uniform vec4 diffuse;
uniform vec3 ambient;
uniform vec3 emissive;

#endif //LIGHTVS

#if defined(TEXSHADE) || defined(PNORMAL)

uniform vec4 specular;

#endif

#ifdef PTEX0
uniform sampler2D texAlbedo;
uniform sampler2D texAlbedo2;
#endif


void main()
{
    //-------------
    vec4 color;

////////////////////
#ifdef TEXALBEDO
    color = texture2D(texAlbedo, v_tex0);
#else
    color = diffuse;
#endif

#ifdef PCOLOR
    color *= v_color0;
#endif

//////////////////
// omit alpha test
#ifdef ALPHATEST
    //if(color.w<ALPHA_REF){
    //    discard;
    //}
#endif

#ifdef LIGHTVS

#ifdef TEXSHADE
    vec3 c = texture2D(texAlbedo2, v_tex3).xyz;
    color.xyz = (color.xyz * c + v_specular0.xyz) * dlColor.xyz + ambient * color.xyz;
#else
    color.xyz = (color.xyz * v_specular0.w + v_specular0.xyz) * dlColor.xyz + ambient * color.xyz;
#endif //TEXSHADE

#elif defined(TEXSHADE)
    vec3 N = normalize(v_normal);
    vec3 L = dlDir;
    vec3 E = normalize(camPos - v_pos0);
    vec3 H = normalize(L+E); //half vector

    float cosNL = max(c_fzero, dot(N,L));
    float cosNH = max(c_fzero, dot(N,H));
    //float cosNE = max(c_fzero, dot(N,E));

    vec2 sample;
    //sample.x = cosNE; //‚±‚¿‚ç‘¤‚ÍƒJƒbƒg
    sample.x = cosNL;
    sample.y = cosNL;

    vec3 c = texture2D(texAlbedo2, sample).xyz;

    float shininess = specular.w;

    float rs = pow(cosNH, shininess);

    color.xyz = (color.xyz * c + specular.xyz * rs) * dlColor.xyz + ambient * color.xyz;

    //color.xyz = color.xyz * c * dlColor.xyz + ambient * color.xyz; //omit specular

#elif defined(PNORMAL)
    vec3 N = normalize(v_normal);
    vec3 L = dlDir;
    vec3 E = normalize(camPos - v_pos0);
    vec3 H = normalize(L+E); //half vector

    float cosNH = max(c_fzero, dot(N,H));
    //float cosNE = max(c_fzero, dot(N,E));

    float shininess = specular.w;
    float rs = pow(cosNH, shininess);

    color.xyz = (color.xyz * cosNH + specular.xyz * rs) * dlColor.xyz + ambient * color.xyz;

    //color.xyz = (color.xyz * cosNH + specular.xyz * (rs + cosNH * (c_fone - cosNE))) * dlColor.xyz;
    //color.xyz += ambient * color.xyz;

    //color.xyz = color.xyz * cosNH * dlColor.xyz + ambient * color.xyz; //omit specular
#else
    color.xyz *= dlColor.xyz;
#endif

#ifdef EMISSIVE
    color.xyz += emissive;
#endif

    gl_FragColor = color;
}
