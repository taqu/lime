"//precision mediump float;\n"
"precision highp float;\n"
"precision mediump int;\n"
"#define NUM_PALETTE_MATRICES 36\n"
"const int c_izero = 0;\n"
"const int c_ione = 1;\n"
"const int c_itwo = 2;\n"
"const int c_ithree = 3;\n"
"const float f_1_100 = 0.01;\n"
"uniform mat4 mwvp; //World * View * Projection Matrix\n"
"#if defined(VDIFFUSE) && defined(PCOLOR)\n"
"uniform vec3 dlDir;\n"
"uniform vec4 dlColor;\n"
"uniform vec3 ambient;\n"
"#endif\n"
"//--------------------------------\n"
"attribute vec3 a_pos0;\n"
"#ifdef VNORMAL\n"
"attribute vec4 a_normal0;\n"
"#endif\n"
"#ifdef VTEX0\n"
"attribute vec2 a_tex0;\n"
"#endif\n"
"#ifdef VTEX1\n"
"attribute vec2 a_tex1;\n"
"#endif\n"
"#ifdef VBONE\n"
"attribute vec4 a_indices0;\n"
"#endif\n"
"//-------------------------------------\n"
"#ifdef PNORMAL\n"
"varying vec3 v_normal;\n"
"#endif\n"
"#ifdef PCOLOR\n"
"varying  vec4 v_color0;\n"
"#endif\n"
"#ifdef PTEX0\n"
"varying vec2 v_tex0;\n"
"#endif\n"
"#ifdef PTEX1\n"
"varying vec2 v_tex1;\n"
"#endif\n"
"#ifdef PPOS\n"
"varying vec3 v_pos0;\n"
"#endif\n"
"#ifdef SKINNING\n"
"uniform vec4 palette[NUM_PALETTE_MATRICES*3];\n"
"void skinning_position(inout vec4 ret, in vec4 position, float weight, int index)\n"
"{\n"
"    vec4 tmp;\n"
"    tmp.x = dot(position, palette[index      ]);\n"
"    tmp.y = dot(position, palette[index+c_ione]);\n"
"    tmp.z = dot(position, palette[index+c_itwo]);\n"
"    tmp.w = position.w;\n"
"    ret += weight * tmp;\n"
"}\n"
"void skinning_normal(inout vec3 ret, in vec3 normal, float weight, int index)\n"
"{\n"
"    vec3 tmp;\n"
"    tmp.x = dot(normal, palette[index      ].xyz);\n"
"    tmp.y = dot(normal, palette[index+c_ione].xyz);\n"
"    tmp.z = dot(normal, palette[index+c_itwo].xyz);\n"
"    ret += weight * tmp;\n"
"}\n"
"#if defined(PNORMAL) || (defined(LIGHTVS) && defined(VNORMAL))\n"
"void skinning(in vec4 position, in vec3 normal, out vec4 retPosition, out vec3 retNormal)\n"
"{\n"
"    retPosition = vec4(float(c_izero));\n"
"    retNormal = vec3(float(c_izero));\n"
"    float weight = a_indices0.z * f_1_100;\n"
"    int index = int(a_indices0.x) * c_ithree;\n"
"    skinning_position(retPosition, position, weight, index);\n"
"    skinning_normal(retNormal, normal, weight, index);\n"
"    weight = float(c_ione) - weight;\n"
"    index = int(a_indices0.y) * c_ithree;\n"
"    skinning_position(retPosition, position, weight, index);\n"
"    skinning_normal(retNormal, normal, weight, index);\n"
"}\n"
"#else\n"
"void skinning(in vec4 position, out vec4 retPosition)\n"
"{\n"
"    retPosition = vec4(float(c_izero));\n"
"    float weight = a_indices0.z * f_1_100;\n"
"    int index = int(a_indices0.x) * c_ithree;\n"
"    skinning_position(retPosition, position, weight, index);\n"
"    weight = float(c_ione) - weight;\n"
"    index = int(a_indices0.y) * c_ithree;\n"
"    skinning_position(retPosition, position, weight, index);\n"
"}\n"
"#endif\n"
"#endif\n"
"#ifdef LIGHTVS\n"
"uniform vec3 dlDir;\n"
"uniform vec3 camPos;\n"
"uniform vec4 specular;\n"
"varying vec4 v_specular0;\n"
"#ifdef TEXSHADE\n"
"varying vec2 v_tex3;\n"
"#endif\n"
"#endif //LIGHTVS\n"
"void main()\n"
"{\n"
"    vec4 position;\n"
"    vec3 normal;\n"
"#ifdef SKINNING\n"
"#if defined(PNORMAL) || (defined(LIGHTVS) && defined(VNORMAL))\n"
"    skinning(vec4(a_pos0.xyz, float(c_ione)), a_normal0.xyz, position, normal);\n"
"#else\n"
"    skinning(vec4(a_pos0.xyz, float(c_ione)), position);\n"
"#endif //PNORMAL\n"
"#else //SKINNING\n"
"    position = vec4(a_pos0.xyz, float(c_ione));\n"
"#ifdef VNORMAL\n"
"    normal = a_normal0.xyz;\n"
"#endif //VNORMAL\n"
"#endif //SKINNING\n"
"#ifdef PPOS\n"
"    v_pos0 = position.xyz;\n"
"#endif\n"
"#ifdef LIGHTVS\n"
"    vec3 posLighting = position.xyz;\n"
"#endif\n"
"    position = mwvp * position;\n"
"//linear-z\n"
"    position.z *= position.w;\n"
"    gl_Position = position;\n"
"#ifdef PNORMAL\n"
"    v_normal = normal;\n"
"#endif\n"
"#ifdef PTEX0\n"
"    v_tex0 = a_tex0;\n"
"#endif\n"
"#ifdef PTEX1\n"
"    v_tex1 = a_tex1;\n"
"#endif\n"
"#if defined(VDIFFUSE) && defined(PCOLOR)\n"
"    vec3 L = dlDir;\n"
"    v_color0 = ambient + dlColor.w * max(dlColor.xyz * dot(normal, L), float(c_izero));//Irradiance\n"
"#endif\n"
"///////////////////////////////////////////////////\n"
"#ifdef LIGHTVS\n"
"#ifdef VNORMAL\n"
"#ifdef TEXSHADE\n"
"    vec3 L = dlDir;\n"
"    vec3 N = normalize(normal);\n"
"    vec3 E = normalize(camPos - posLighting);\n"
"    vec3 H = normalize(L+E);\n"
"    float cosNL = max(float(c_izero), dot(N,L));\n"
"    float cosNH = max(float(c_izero), dot(N,H));\n"
"    v_tex3 = vec2(cosNL);\n"
"    float shininess = specular.w;\n"
"    float rs = pow(cosNH, shininess);\n"
"    v_specular0.xyz = specular.xyz * rs;\n"
"    v_specular0.w = cosNL;\n"
"#else //TEXSHADE\n"
"    vec3 L = dlDir;\n"
"    vec3 N = normalize(normal);\n"
"    vec3 E = normalize(camPos - posLighting);\n"
"    vec3 H = normalize(L+E);\n"
"    float cosNL = max(float(c_izero), dot(N,L));\n"
"    float cosNH = max(float(c_izero), dot(N,H));\n"
"    float shininess = specular.w;\n"
"    float rs = pow(cosNH, shininess);\n"
"    v_specular0.xyz = specular.xyz * rs;\n"
"    v_specular0.w = cosNL;\n"
"#endif //TEXSHADE\n"
"#else\n"
"    v_specular0.xyz = vec3(float(c_izero));\n"
"    v_specular0.w = float(c_ione);\n"
"#endif\n"
"#endif //LIGHTVS\n"
"}\n"
